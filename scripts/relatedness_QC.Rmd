---
title: "GWAS QC: Sample Relatedness"
author: "Shea Andrews"
date: "`r Sys.Date()`"
output: html_document
params:
  Path_IBD_stats:
  Sample:
  Family: F
  pi_threshold: 0.1875
editor_options:
  chunk_output_type: console
---

## Cryptic Relatdness
Population based cohorts are often limited to unrelated individules as associations statisitcs often assume independence across individules. Closely related samples will share more of their genome and are likely to be more phenotypically similar than than two individules chosen randomly from the population. A common measure of relatedness is identity by descent (IBD), where a kinship correlation coefficent (pi-hat) greater 0.1 suggests that samples maybe related or duplicates samples.
<br>

Identifing duplicated or related samples can be done in PLINK by typing the following command at the shell prompt. This produce a file containing the pariwise IBS estimates for all pairs of individules with minimum IBS of 0.05. Analysis should be performed using an LD pruned snplist.
```{bash, eval=F}
plink_1.9 --bfile raw-GWA-data \
  --extract snplist.prune.in \
  --genome --min 0.05 --out output.het
```
<br>

```{r setup relatedness, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = params$rwd)

## ---- Load Pacakges ---- ##
library(tidyverse)
library(ggplot2)
library(plotly)     ## For 3d interactive scatter plots
library(magrittr)
library(knitr)
```


```{r readData, echo=F, warning=F, message=F}
## ---- Read in Data ----##
message(params$Path_IBD_stats)
Pi_threshold <- params$pi_threshold
dat.inter.raw <- load(params$Path_IBD_stats)
```

The following histogram (Fig. 1) shows the distribution of pairwise kingship coefficents between all pairs.
```{r plot kinship, distribution of pairwise kinship coefficnts, echo=FALSE, fig.width=4.7, fig.height=4.7, fig.align='center', fig.cap='Fig. 1: Distribution of pairwise kinship coefficents'}
ggplot(dat.inter, aes(x = PI_HAT)) +
  geom_histogram(binwidth = 0.01, fill = "#377EB8") + lims(x = 0:1) +
  theme_bw() + labs(x = 'Kinship Coefficent (pi-hat)') +
  geom_vline(xintercept = Pi_threshold, colour = 'red', linetype = 2)

```
\

Relationship between pairs of indiviudules is based on the following value IBD values:

***Table 1:*** IBD relationships
```{r reL_table, echo=FALSE}
as.data.frame(rel_tab)
```

The following plot (Fig. 2) shows the proportion loci sharing one allele IBD (Z1) by the proportion of loci where individules share zero alleles (Z0), where the kinship coefficent is greater than 0.05. In family based studies, pairs are coloured by IBD relationship. Table 2 displays the individules where the kinship coefficent was greather than `r Pi_threshold` in population based studies OR how were duplicates in family based studies.
```{r relatdness plot, echo=FALSE, fig.width=7.5, fig.height=4.7, fig.align='center', fig.cap='Fig. 2: Pairs of individules plotted by their degree of relatedness'}

if(params$Family == F){
  ggplot(dat.inter, aes(x = Z0, y = Z1, colour = PI_HAT > Pi_threshold)) +
  #geom_label_repel(data = filter(dat.inter, PI_HAT > 0.1), aes(x = Z0, y = Z1, label = paste(IID1, '-', IID2))) +
  geom_point() + lims(x = 0:1, y = 0:1) +
  scale_colour_manual(name = sprintf("PI HAT > %f", Pi_threshold),
  values = c("#377EB8", "#E41A1C")) +
  labs(x = 'IBD Z0', y = 'IBD Z1') +
  coord_fixed() + theme_bw() + theme(legend.position="bottom")
} else {
  ggplot(dat.inter, aes(x = Z0, y = Z1, colour = relationship)) +
  geom_point() + lims(x = 0:1, y = 0:1) +
  labs(x = 'IBD Z0', y = 'IBD Z1') +
  coord_fixed() + theme_bw() + theme(legend.position="right")
}
```

***Table 2:*** Samples with a kinship coefficent > `r Pi_threshold`
```{r table ibd, echo=FALSE}
as.data.frame(ibd_tab)
```

To construct a sample of unrelated individules, participants with the highest number of pairwise kinship coefficents > `r Pi_threshold` can be iterativly removed.

The following samples were excluded due to relatdness:
```{r pressure, echo=FALSE, warning=FALSE}
fam_table
```
<br>
