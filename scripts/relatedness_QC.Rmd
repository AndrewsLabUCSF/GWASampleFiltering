---
title: "GWAS QC: Sample Relatedness"
author: "Shea Andrews"
date: "`r Sys.Date()`"
output: html_document
params:
  Path_GenomeFile: 
  Path_FamFile: 
  Sample: 
editor_options: 
  chunk_output_type: console
---

## Cryptic Relatdness 
Population based cohorts are often limited to unrelated individules as associations statisitcs often assume independence across individules. Closely related samples will share more of their genome and are likely to be more phenotypically similar than than two individules chosen randomly from the population. A common measure of relatedness is identity by descent (IBD), where a kinship correlation coefficent (pi-hat) greater 0.1 suggests that samples maybe related or duplicates samples. 
<br> 

Identifing duplicated or related samples can be done in PLINK by typing the following command at the shell prompt. This produce a file containing the pariwise IBS estimates for all pairs of individules with minimum IBS of 0.05. Analysis should be performed using an LD pruned snplist. 
```{bash, eval=F}
plink_1.9 --bfile raw-GWA-data \
  --extract snplist.prune.in \
  --genome --min 0.05 --out output.het
```
<br> 

```{r setup realatdness, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = params$rwd)

## ---- Load Pacakges ---- ##
library(tidyverse)
library(ggplot2)
library(knitr)
```

```{r readData, echo=F, warning=F, message=F}
## ---- Read in Data ----##

##  Read in .genome file obtained from PLINK using the --genome option
dat.inter <- as.tibble(read.table(params$Path_GenomeFile, header = TRUE, check.names = FALSE, as.is = TRUE))
#dat.inter <- read_table(params$Path_GenomeFile, col_names = TRUE)

##  Read in PLINK .fam file
fam <- read_delim(params$Path_FamFile, delim = " ", col_names = F)
```

The following hisogram (Fig. 1) shows the distribution of pairwise kingship coefficents between all pairs. 
```{r plot kinship, distribution of pairwise kinship coefficnts, echo=FALSE, fig.width=4.7, fig.height=4.7, fig.align='center', fig.cap='Fig. 1: Distribution of pairwise kinship coefficents'}
ggplot(dat.inter, aes(x = PI_HAT)) + 
  geom_histogram(binwidth = 0.01, fill = "#377EB8") + lims(x = 0:1) +
  theme_bw() + labs(x = 'Kinship Coefficent (pi-hat)') + 
  geom_vline(xintercept = 0.1, colour = 'red', linetype = 2)

```
\

The following plot (Fig. 2) shows the proportion loci sharing one allele IBD (Z1) by the proportion of loci where individules share zero alleles (Z0), where the kinship coefficent is greater than 0.05. Table 1 displays the individules where the kinship coefficent was greather than 0.1.  
```{r relatdness plot, echo=FALSE, fig.width=7.5, fig.height=4.7, fig.align='center', fig.cap='Fig. 2: Pairs of individules plotted by their degree of relatedness'}
ggplot(dat.inter, aes(x = Z0, y = Z1, colour = PI_HAT > 0.1)) + 
  #geom_label_repel(data = filter(dat.inter, PI_HAT > 0.1), aes(x = Z0, y = Z1, label = paste(IID1, '-', IID2))) + 
  geom_point() + lims(x = 0:1, y = 0:1) + 
  scale_colour_manual(name = c('PI HAT > 0.1'), values = c("#E41A1C", "#377EB8")) + 
  labs(x = 'IBD Z0', y = 'IBD Z1') + 
  coord_fixed() + theme_bw() + theme(legend.position="bottom")

```

***Table 1:*** Samples with a kinship coefficent > 0.1
```{r table ibd, echo=FALSE}
ibdcoeff <- filter(dat.inter, PI_HAT > 0.1)
as.data.frame(ibdcoeff)
```

To construct a sample of unrelated individules, participants with the highest number of pairwise kinship coefficents >0.1 can be iterativly removed. 

The following samples were excluded due to relatdness:
```{r pressure, echo=FALSE, warning=FALSE}
##  select samples with kinship cofficents > 0.1
##  Iterativly remove subjects with the highest number of pairwise kinship cofficents > 0.1 
##  see http://www.stat-gen.org/tut/tut_preproc.html 
related.samples <- NULL
excluded <- list()
while(nrow(ibdcoeff) >0 ){
  sample.counts <- arrange(plyr:::count(c(ibdcoeff$IID1, ibdcoeff$IID2)), -freq)
  rm.sample <- sample.counts[1,'x']
  excluded <- c(paste("Removing sample", as.character(rm.sample), 'to closely related to', sample.counts[1, 'freq'], 'other samples.'), excluded)
  ibdcoeff <- ibdcoeff[ibdcoeff$IID1 != rm.sample & ibdcoeff$IID2 != rm.sample,]
  related.samples <- c(as.character(rm.sample), related.samples)
}

as.data.frame(do.call(rbind, excluded))

```
<br>






